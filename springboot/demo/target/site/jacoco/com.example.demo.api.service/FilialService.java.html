<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FilialService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">demo</a> &gt; <a href="index.source.html" class="el_package">com.example.demo.api.service</a> &gt; <span class="el_source">FilialService.java</span></div><h1>FilialService.java</h1><pre class="source lang-java linenums">package com.example.demo.api.service;

import java.util.Collections;
import java.util.List;
import java.util.Optional;

import org.springframework.http.HttpStatus;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.server.ResponseStatusException;

import com.example.demo.api.dto.FerramentaDTO;
import com.example.demo.api.dto.FilialDetalheDTO;
import com.example.demo.api.dto.FilialResumoDTO;
import com.example.demo.api.dto.MaterialConstrucaoDTO;
import com.example.demo.api.model.FerramentaEntity;
import com.example.demo.api.model.FilialEntity;
import com.example.demo.api.model.MaterialConstrucaoEntity;
import com.example.demo.api.repository.FilialRepository;
import lombok.RequiredArgsConstructor;

@Service
<span class="fc" id="L24">@RequiredArgsConstructor</span>
public class FilialService {

    private final FilialRepository filialRepository;
    private final PasswordEncoder passwordEncoder;

    @Transactional(readOnly = true)
    public List&lt;FilialResumoDTO&gt; listarTodas() {
<span class="nc" id="L32">        return filialRepository.findAll()</span>
<span class="nc" id="L33">                .stream()</span>
<span class="nc" id="L34">                .map(this::mapearParaResumo)</span>
<span class="nc" id="L35">                .toList();</span>
    }

    @Transactional(readOnly = true)
    public Optional&lt;FilialDetalheDTO&gt; buscarPorId(Integer id) {
<span class="nc" id="L40">        return filialRepository.findById(id)</span>
<span class="nc" id="L41">                .map(this::mapearParaDetalhe);</span>
    }

    @Transactional
    public FilialDetalheDTO criar(FilialResumoDTO dto) {
<span class="fc" id="L46">        FilialEntity entity = new FilialEntity();</span>
<span class="fc" id="L47">        atualizarCampos(entity, dto);</span>
<span class="fc" id="L48">        FilialEntity salvo = filialRepository.save(entity);</span>
<span class="fc" id="L49">        return mapearParaDetalhe(salvo);</span>
    }

    @Transactional
    public Optional&lt;FilialDetalheDTO&gt; atualizar(Integer id, FilialResumoDTO dto) {
<span class="fc" id="L54">        return filialRepository.findById(id)</span>
<span class="fc" id="L55">                .map(entity -&gt; {</span>
<span class="fc" id="L56">                    atualizarCampos(entity, dto);</span>
<span class="fc" id="L57">                    FilialEntity salvo = filialRepository.save(entity);</span>
<span class="fc" id="L58">                    return mapearParaDetalhe(salvo);</span>
                });
    }

    @Transactional
    public boolean deletar(Integer id) {
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (!filialRepository.existsById(id)) {</span>
<span class="nc" id="L65">            return false;</span>
        }
<span class="nc" id="L67">        filialRepository.deleteById(id);</span>
<span class="nc" id="L68">        return true;</span>
    }

    private void atualizarCampos(FilialEntity entity, FilialResumoDTO dto) {
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">        if (dto == null) {</span>
<span class="nc" id="L73">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Dados da filial sao obrigatorios&quot;);</span>
        }

<span class="fc" id="L76">        Integer dtoId = normalizarId(dto.getIdFilial());</span>
<span class="fc" id="L77">        atualizarIdFilial(entity, dtoId);</span>
<span class="fc" id="L78">        entity.setNome(validarNome(dto.getNome()));</span>
<span class="fc" id="L79">        atualizarLogin(entity, dto.getLogin());</span>
<span class="fc" id="L80">        atualizarSenha(entity, dto.getSenha());</span>
<span class="fc" id="L81">        atualizarStatus(entity, dto.getAtivo());</span>
<span class="fc" id="L82">    }</span>

    private Integer normalizarId(Integer id) {
<span class="pc bpc" id="L85" title="1 of 4 branches missed.">        if (id == null || id &lt;= 0) {</span>
<span class="fc" id="L86">            return null;</span>
        }
<span class="fc" id="L88">        return id;</span>
    }

    private void atualizarIdFilial(FilialEntity entity, Integer dtoId) {
<span class="fc bfc" id="L92" title="All 2 branches covered.">        if (entity.getIdFilial() == null) {</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">            if (dtoId != null) {</span>
<span class="nc" id="L94">                entity.setIdFilial(dtoId);</span>
            }
<span class="fc" id="L96">            return;</span>
        }

<span class="pc bpc" id="L99" title="1 of 4 branches missed.">        if (dtoId != null &amp;&amp; !entity.getIdFilial().equals(dtoId)) {</span>
<span class="fc" id="L100">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Nao e permitido alterar o codigo da filial&quot;);</span>
        }
<span class="fc" id="L102">    }</span>

    private String validarNome(String nome) {
<span class="fc bfc" id="L105" title="All 4 branches covered.">        if (nome == null || nome.isBlank()) {</span>
<span class="fc" id="L106">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Nome da filial e obrigatorio&quot;);</span>
        }
<span class="fc" id="L108">        return nome.trim();</span>
    }

    private void atualizarLogin(FilialEntity entity, String login) {
<span class="fc bfc" id="L112" title="All 4 branches covered.">        if (login == null || login.isBlank()) {</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">            if (entity.getLogin() == null) {</span>
<span class="fc" id="L114">                throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Login da filial e obrigatorio&quot;);</span>
            }
<span class="nc" id="L116">            return;</span>
        }
<span class="fc" id="L118">        entity.setLogin(login.trim());</span>
<span class="fc" id="L119">    }</span>

    private void atualizarSenha(FilialEntity entity, String senha) {
<span class="fc bfc" id="L122" title="All 2 branches covered.">        if (entity.getSenhaHash() == null) {</span>
<span class="pc bpc" id="L123" title="2 of 4 branches missed.">            if (senha == null || senha.isBlank()) {</span>
<span class="nc" id="L124">                throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Senha da filial e obrigatoria&quot;);</span>
            }
<span class="fc" id="L126">            entity.setSenhaHash(passwordEncoder.encode(senha));</span>
<span class="fc" id="L127">            return;</span>
        }

<span class="pc bpc" id="L130" title="3 of 4 branches missed.">        if (senha != null &amp;&amp; !senha.isBlank()) {</span>
<span class="nc" id="L131">            entity.setSenhaHash(passwordEncoder.encode(senha));</span>
        }
<span class="fc" id="L133">    }</span>

    private void atualizarStatus(FilialEntity entidade, Boolean ativo) {
<span class="fc bfc" id="L136" title="All 2 branches covered.">        if (ativo != null) {</span>
<span class="fc" id="L137">            entidade.setAtivo(ativo);</span>
<span class="fc" id="L138">            return;</span>
        }

<span class="fc bfc" id="L141" title="All 2 branches covered.">        if (entidade.getAtivo() == null) {</span>
<span class="fc" id="L142">            entidade.setAtivo(Boolean.TRUE);</span>
        }
<span class="fc" id="L144">    }</span>

    private FilialResumoDTO mapearParaResumo(FilialEntity entity) {
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L148">            return null;</span>
        }

<span class="nc" id="L151">        return FilialResumoDTO.builder()</span>
<span class="nc" id="L152">                .idFilial(entity.getIdFilial())</span>
<span class="nc" id="L153">                .nome(entity.getNome())</span>
<span class="nc" id="L154">                .login(entity.getLogin())</span>
<span class="nc" id="L155">                .ativo(entity.getAtivo())</span>
<span class="nc" id="L156">                .build();</span>
    }

    private FilialDetalheDTO mapearParaDetalhe(FilialEntity entity) {
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L161">            return null;</span>
        }

<span class="fc" id="L164">        List&lt;FerramentaDTO&gt; ferramentas = Optional.ofNullable(entity.getFerramentas())</span>
<span class="fc" id="L165">                .orElse(Collections.emptyList())</span>
<span class="fc" id="L166">                .stream()</span>
<span class="fc" id="L167">                .map(this::mapearFerramenta)</span>
<span class="fc" id="L168">                .toList();</span>

<span class="fc" id="L170">        List&lt;MaterialConstrucaoDTO&gt; materiais = Optional.ofNullable(entity.getMateriais())</span>
<span class="fc" id="L171">                .orElse(Collections.emptyList())</span>
<span class="fc" id="L172">                .stream()</span>
<span class="fc" id="L173">                .map(this::mapearMaterial)</span>
<span class="fc" id="L174">                .toList();</span>

<span class="fc" id="L176">        return FilialDetalheDTO.builder()</span>
<span class="fc" id="L177">                .idFilial(entity.getIdFilial())</span>
<span class="fc" id="L178">                .nome(entity.getNome())</span>
<span class="fc" id="L179">                .ferramentas(ferramentas)</span>
<span class="fc" id="L180">                .materiais(materiais)</span>
<span class="fc" id="L181">                .build();</span>
    }

    private FerramentaDTO mapearFerramenta(FerramentaEntity entity) {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L186">            return null;</span>
        }

<span class="nc" id="L189">        return FerramentaDTO.builder()</span>
<span class="nc" id="L190">                .codFerramenta(entity.getCodFerramenta())</span>
<span class="nc" id="L191">                .codigoProduto(entity.getCodigoProduto())</span>
<span class="nc" id="L192">                .valor(entity.getValor())</span>
<span class="nc" id="L193">                .marca(entity.getMarca())</span>
<span class="nc" id="L194">                .nome(entity.getNome())</span>
<span class="nc" id="L195">                .qtdPacote(entity.getQtdPacote())</span>
<span class="nc" id="L196">                .filial(mapearParaResumo(entity.getFilial()))</span>
<span class="nc" id="L197">                .build();</span>
    }

    private MaterialConstrucaoDTO mapearMaterial(MaterialConstrucaoEntity entity) {
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L202">            return null;</span>
        }

<span class="nc" id="L205">        return MaterialConstrucaoDTO.builder()</span>
<span class="nc" id="L206">                .codMaterial(entity.getCodMaterial())</span>
<span class="nc" id="L207">                .codigoProduto(entity.getCodigoProduto())</span>
<span class="nc" id="L208">                .valor(entity.getValor())</span>
<span class="nc" id="L209">                .cor(entity.getCor())</span>
<span class="nc" id="L210">                .nome(entity.getNome())</span>
<span class="nc" id="L211">                .materiaPrima(entity.getMateriaPrima())</span>
<span class="nc" id="L212">                .filial(mapearParaResumo(entity.getFilial()))</span>
<span class="nc" id="L213">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>